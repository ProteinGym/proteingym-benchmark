schema: '2.0'
stages:
  supervised_predict@dataset0-model0:
    cmd: uv run pg2-benchmark model predict --dataset-manifest data/dummy/charge_ladder.toml
      --model-manifest model/pls.toml --model-dockerfile-folder ../models/pls --model-name
      pls
    deps:
    - path: ../models/pls
      hash: md5
      md5: 74c2d0b3e574721e11c4b22037b719d8.dir
      size: 545889182
      nfiles: 17723
    - path: ../src/pg2_benchmark/cli/model.py
      hash: md5
      md5: 7b69bd48d88f96c7e759334208c24226
      size: 1687
    - path: data/dummy/charge_ladder.toml
      hash: md5
      md5: 4c4119e8f92050f97396da01c5ba5fba
      size: 248
    - path: model/pls.toml
      hash: md5
      md5: 751569f65bbbc4d796ddc02a70dce809
      size: 185
    outs:
    - path: output/charge_ladder_pls.csv
      hash: md5
      md5: ef556a0d7ac455181a1d411bc08c31f4
      size: 13804
  supervised_predict@dataset1-model0:
    cmd: uv run pg2-benchmark model predict --dataset-manifest data/neime/neime.toml
      --model-manifest model/pls.toml --model-dockerfile-folder ../models/pls --model-name
      pls
    deps:
    - path: ../models/pls
      hash: md5
      md5: 74c2d0b3e574721e11c4b22037b719d8.dir
      size: 545889182
      nfiles: 17723
    - path: ../src/pg2_benchmark/cli/model.py
      hash: md5
      md5: 7b69bd48d88f96c7e759334208c24226
      size: 1687
    - path: data/neime/neime.toml
      hash: md5
      md5: 394178d3ffeda14fdad7a77c88d4c831
      size: 266
    - path: model/pls.toml
      hash: md5
      md5: 751569f65bbbc4d796ddc02a70dce809
      size: 185
    outs:
    - path: output/neime_pls.csv
      hash: md5
      md5: 6252ba808a67123a7b8cac479a09353a
      size: 35000
  supervised_metric@dataset0-model0:
    cmd: uv run pg2-benchmark metric calc --output-path output/charge_ladder_pls.csv
      --metric-path metric/charge_ladder_pls.csv
    deps:
    - path: ../src/pg2_benchmark/cli/metric.py
      hash: md5
      md5: 2f2a5d08badb89c5d507fa9e2e5bbe2d
      size: 774
    - path: output/charge_ladder_pls.csv
      hash: md5
      md5: ef556a0d7ac455181a1d411bc08c31f4
      size: 13804
    outs:
    - path: metric/charge_ladder_pls.csv
      hash: md5
      md5: fa004fd33461b45d30ae53fe955d74a0
      size: 1457
  supervised_metric@dataset1-model0:
    cmd: uv run pg2-benchmark metric calc --output-path output/neime_pls.csv --metric-path
      metric/neime_pls.csv
    deps:
    - path: ../src/pg2_benchmark/cli/metric.py
      hash: md5
      md5: 2f2a5d08badb89c5d507fa9e2e5bbe2d
      size: 774
    - path: output/neime_pls.csv
      hash: md5
      md5: 6252ba808a67123a7b8cac479a09353a
      size: 35000
    outs:
    - path: metric/neime_pls.csv
      hash: md5
      md5: 663575a8ea164a40b0c25e475c61dc4b
      size: 1566
  upload:
    cmd: uv run pg2-benchmark aws upload data --s3-training-data-bucket pg2-benchmark-training-data
      --aws-region eu-north-1
    deps:
    - path: ../src/pg2_benchmark/cli/aws.py
      hash: md5
      md5: 115da6eb4b3f96e82f1675fe69a07c12
      size: 4588
    - path: data
      hash: md5
      md5: 103124ed4524aaf16ee56d31febbca6b.dir
      size: 233128
      nfiles: 4
    outs:
    - path: s3://pg2-benchmark-training-data/data
      hash: md5
      md5: e239ca74f56069ee73543fe551cd5af6.dir
      size: 233128
      nfiles: 4
  upload_data:
    cmd: uv run pg2-benchmark aws upload data --s3-training-data-bucket pg2-benchmark-training-data
      --aws-region eu-north-1
    deps:
    - path: ../src/pg2_benchmark/cli/aws.py
      hash: md5
      md5: aa547041a397575065db555bde653503
      size: 4880
    - path: data
      hash: md5
      md5: 103124ed4524aaf16ee56d31febbca6b.dir
      size: 233128
      nfiles: 4
    outs:
    - path: s3://pg2-benchmark-training-data/data
      hash: md5
      md5: e239ca74f56069ee73543fe551cd5af6.dir
      size: 233128
      nfiles: 4
  upload_model:
    cmd: uv run pg2-benchmark aws upload model --s3-training-data-bucket pg2-benchmark-training-data
      --aws-region eu-north-1
    deps:
    - path: ../src/pg2_benchmark/cli/aws.py
      hash: md5
      md5: aa547041a397575065db555bde653503
      size: 4880
    - path: model
      hash: md5
      md5: b271d5385e717be29cd6221c4069c854.dir
      size: 185
      nfiles: 1
    outs:
    - path: s3://pg2-benchmark-training-data/model
      hash: md5
      md5: 26a8aeee4aafd4c90682f907f58701cc.dir
      size: 185
      nfiles: 1
  create_sagemaker_training_job@dataset0-model0:
    cmd: uv run pg2-benchmark aws create-sagemaker-training-job --aws-region eu-north-1
      --instance-type ml.m5.xlarge --volume-size 5 --ecr-repository-uri 644482713970.dkr.ecr.eu-north-1.amazonaws.com/pls
      --sagemaker-role-name ml-pipeline-terraform-demo-sagemaker-exec --s3-training-data-bucket
      pg2-benchmark-training-data --s3-output-bucket pg2-benchmark-output --dataset-toml-file
      data/dummy/charge_ladder.toml --model-toml-file model/pls.toml
  create_sagemaker_training_job@dataset1-model0:
    cmd: uv run pg2-benchmark aws create-sagemaker-training-job --aws-region eu-north-1
      --instance-type ml.m5.xlarge --volume-size 5 --ecr-repository-uri 644482713970.dkr.ecr.eu-north-1.amazonaws.com/pls
      --sagemaker-role-name ml-pipeline-terraform-demo-sagemaker-exec --s3-training-data-bucket
      pg2-benchmark-training-data --s3-output-bucket pg2-benchmark-output --dataset-toml-file
      data/neime/neime.toml --model-toml-file model/pls.toml
  build_and_push_image@model0:
    cmd:
    - aws ecr get-login-password --region eu-north-1 | docker login --username AWS
      --password-stdin 644482713970.dkr.ecr.eu-north-1.amazonaws.com
    - aws ecr create-repository --repository-name pls --region eu-north-1
    - uv run pg2-benchmark aws build-and-push-image ../models/pls --model-name pls
      --ecr-uri 644482713970.dkr.ecr.eu-north-1.amazonaws.com
    deps:
    - path: ../src/pg2_benchmark/cli/aws.py
      hash: md5
      md5: aa547041a397575065db555bde653503
      size: 4880
  upload_to_s3:
    cmd:
    - aws s3 mb s3://pg2-benchmark-training-data --region eu-north-1 || true
    - aws s3 mb s3://pg2-benchmark-output --region eu-north-1 || true
    - aws s3 cp data/ s3://pg2-benchmark-training-data/data/ --recursive --exclude
      ".*" --exclude "*/.*"
    - aws s3 cp model/ s3://pg2-benchmark-training-data/model/ --recursive --exclude
      ".*" --exclude "*/.*"
    - echo "Upload completed at $(date)" > logs/s3_upload_complete.txt
    deps:
    - path: data/
      hash: md5
      md5: 4c049aee14d085d26d1aed6c8e4c56ae.dir
      size: 239288
      nfiles: 5
    - path: model/
      hash: md5
      md5: b271d5385e717be29cd6221c4069c854.dir
      size: 185
      nfiles: 1
    outs:
    - path: logs/s3_upload_complete.txt
      hash: md5
      md5: cac600df4cacdfecd124cf52b9146a4c
      size: 50
  deploy_to_ecr@model0:
    cmd:
    - aws ecr describe-repositories --repository-names pls --region eu-north-1 >/dev/null
      2>&1 || aws ecr create-repository --repository-name pls --region eu-north-1
      >/dev/null
    - aws ecr get-login-password --region eu-north-1 | docker login --username AWS
      --password-stdin 644482713970.dkr.ecr.eu-north-1.amazonaws.com
    - docker buildx build --platform linux/amd64,linux/arm64 --secret id=git_auth,src=git-auth.txt
      -t 644482713970.dkr.ecr.eu-north-1.amazonaws.com/pls:latest ../models/pls --no-cache
      --push
    - echo "ECR push completed at $(date)" > logs/ecr_push_complete.txt
    - echo "644482713970.dkr.ecr.eu-north-1.amazonaws.com/pls:latest" > logs/image_uri.txt
    deps:
    - path: ../models/pls
      hash: md5
      md5: 2db8f3c2ba0e00a1d4158af081a3f573.dir
      size: 545915442
      nfiles: 17727
    outs:
    - path: logs/ecr_push_complete.txt
      hash: md5
      md5: 5353a51804e7a20e3df780adde56156e
      size: 52
    - path: logs/image_uri.txt
      hash: md5
      md5: 1ea9949a94d349ac802f9b749fa4496d
      size: 57
  create_training_job@dataset0-model0:
    cmd: "uv run pg2-benchmark aws create-training-job --model-name pls --region-name
      eu-north-1 --role-name pg2-benchmark-sagemaker-role --ecr-repository-uri 644482713970.dkr.ecr.eu-north-1.amazonaws.com/pls
      --s3-training-data-bucket pg2-benchmark-training-data --s3-output-bucket pg2-benchmark-output
      --instance-type ml.m5.xlarge --volume-size 5 --dataset-toml-file data/dummy/charge_ladder.toml
      --model-toml-file model/pls.toml > logs/create_job_charge_ladder_pls.txt\n"
    deps:
    - path: ../src/pg2_benchmark/cli/aws.py
      hash: md5
      md5: baa07219f96493bd33c713230957e004
      size: 4956
    - path: logs/role_create_complete.txt
      hash: md5
      md5: 4f0ddb23b217b1aad187347b6f5c4fda
      size: 56
    outs:
    - path: logs/create_job_charge_ladder_pls.txt
      hash: md5
      md5: 96594a6b6770da000b6d21f8ca674372
      size: 20
  create_training_job@dataset1-model0:
    cmd: "uv run pg2-benchmark aws create-training-job --model-name pls --region-name
      eu-north-1 --role-name pg2-benchmark-sagemaker-role --ecr-repository-uri 644482713970.dkr.ecr.eu-north-1.amazonaws.com/pls
      --s3-training-data-bucket pg2-benchmark-training-data --s3-output-bucket pg2-benchmark-output
      --instance-type ml.m5.xlarge --volume-size 5 --dataset-toml-file data/neime/neime.toml
      --model-toml-file model/pls.toml > logs/create_job_neime_pls.txt\n"
    deps:
    - path: ../src/pg2_benchmark/cli/aws.py
      hash: md5
      md5: baa07219f96493bd33c713230957e004
      size: 4956
    - path: logs/role_create_complete.txt
      hash: md5
      md5: 4f0ddb23b217b1aad187347b6f5c4fda
      size: 56
    outs:
    - path: logs/create_job_neime_pls.txt
      hash: md5
      md5: c2c0bd2da64da17fe1e15543249bc8a4
      size: 20
  create_role:
    cmd:
    - aws iam get-role --role-name pg2-benchmark-sagemaker-role >/dev/null 2>&1 ||
      aws iam create-role --role-name pg2-benchmark-sagemaker-role --assume-role-policy-document
      file://trust-policy.json >/dev/null
    - aws iam attach-role-policy --role-name pg2-benchmark-sagemaker-role --policy-arn
      arn:aws:iam::aws:policy/AmazonSageMakerFullAccess
    - aws iam attach-role-policy --role-name pg2-benchmark-sagemaker-role --policy-arn
      arn:aws:iam::aws:policy/AmazonS3FullAccess
    - echo "SageMaker role created at $(date)" > logs/role_create_complete.txt
    deps:
    - path: logs/ecr_push_complete.txt
      hash: md5
      md5: 5353a51804e7a20e3df780adde56156e
      size: 52
    - path: logs/image_uri.txt
      hash: md5
      md5: 1ea9949a94d349ac802f9b749fa4496d
      size: 57
    - path: logs/s3_upload_complete.txt
      hash: md5
      md5: cac600df4cacdfecd124cf52b9146a4c
      size: 50
    outs:
    - path: logs/role_create_complete.txt
      hash: md5
      md5: 4f0ddb23b217b1aad187347b6f5c4fda
      size: 56
  monitor_training_job@dataset0-model0:
    cmd: "uv run pg2-benchmark aws monitor-training-job --region-name eu-north-1 --job-name
      $(cat logs/create_job_charge_ladder_pls.txt) > logs/monitor_job_charge_ladder_pls.txt\n"
    deps:
    - path: ../src/pg2_benchmark/cli/aws.py
      hash: md5
      md5: baa07219f96493bd33c713230957e004
      size: 4956
    - path: logs/create_job_charge_ladder_pls.txt
      hash: md5
      md5: 96594a6b6770da000b6d21f8ca674372
      size: 20
    outs:
    - path: logs/monitor_job_charge_ladder_pls.txt
      hash: md5
      md5: 019d26f616860ec7803adbaafe6644b1
      size: 201
  monitor_training_job@dataset1-model0:
    cmd: "uv run pg2-benchmark aws monitor-training-job --region-name eu-north-1 --job-name
      $(cat logs/create_job_neime_pls.txt) > logs/monitor_job_neime_pls.txt\n"
    deps:
    - path: ../src/pg2_benchmark/cli/aws.py
      hash: md5
      md5: baa07219f96493bd33c713230957e004
      size: 4956
    - path: logs/create_job_neime_pls.txt
      hash: md5
      md5: c2c0bd2da64da17fe1e15543249bc8a4
      size: 20
    outs:
    - path: logs/monitor_job_neime_pls.txt
      hash: md5
      md5: b710e9a4ad87846fb0e80e86aecc9394
      size: 143
  calculate_metric@dataset0-model0:
    cmd:
    - aws s3 cp s3://pg2-benchmark-output/$(cat logs/create_job_charge_ladder_pls.txt)/output/model.tar.gz
      output/
    - tar -xzf output/model.tar.gz -C output/
    - rm output/model.tar.gz
    - uv run pg2-benchmark metric calc --output-path output/charge_ladder_pls.csv
      --metric-path metric/charge_ladder_pls.csv
    deps:
    - path: logs/monitor_job_charge_ladder_pls.txt
      hash: md5
      md5: e8feb654dd446e89f33d5ec3759a9664
      size: 245
    outs:
    - path: metric/charge_ladder_pls.csv
      hash: md5
      md5: 9375a2304ec886d3fe56df0b6ff85d20
      size: 1457
  calculate_metric@dataset1-model0:
    cmd:
    - aws s3 cp s3://pg2-benchmark-output/$(cat logs/create_job_neime_pls.txt)/output/model.tar.gz
      output/
    - tar -xzf output/model.tar.gz -C output/
    - rm output/model.tar.gz
    - uv run pg2-benchmark metric calc --output-path output/neime_pls.csv --metric-path
      metric/neime_pls.csv
    deps:
    - path: logs/monitor_job_neime_pls.txt
      hash: md5
      md5: 5041bf78e89b49a52eb6b8206e6f7ecc
      size: 158
    outs:
    - path: metric/neime_pls.csv
      hash: md5
      md5: bab3eb3ec4a3ea28d6da9fb25b6f9b0d
      size: 1624
