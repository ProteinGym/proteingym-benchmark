name: validate-model

on:    
  workflow_dispatch:
  pull_request:
    branches: main
  

jobs:
  cml:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - uses: iterative/setup-cml@v2

      - uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install requirements
        run: |
          pip install -r requirements.txt

      - name: Generate datasets and models
        run: |
          # Supervised game: Generate datasets and models if they don't exist
          if [ ! -f benchmark/supervised/datasets.json ]; then
            proteingym-base list-datasets datasets | jq 'map(select(.name == "NEIME_2019")) | map({name: .name, input_filename: .input_filename}) | . = {"datasets": .}' > benchmark/supervised/datasets.json
          else
            echo "benchmark/supervised/datasets.json already exists, skipping generation"
          fi

          if [ ! -f benchmark/supervised/models.json ]; then
            proteingym-base list-models models | jq '[.[] | select(.tags | contains(["supervised"]))] | map({name: .name, input_filename: .input_filename}) | {models: .}' > benchmark/supervised/models.json
          else
            echo "benchmark/supervised/models.json already exists, skipping generation"
          fi

          # Zero-shot game: Generate datasets and models if they don't exist
          if [ ! -f benchmark/zero_shot/datasets.json ]; then
            proteingym-base list-datasets datasets | jq 'map(select(.name == "ranganathan")) | map({name: .name, input_filename: .input_filename}) | . = {"datasets": .}' > benchmark/zero_shot/datasets.json
          else
            echo "benchmark/zero_shot/datasets.json already exists, skipping generation"
          fi

          if [ ! -f benchmark/zero_shot/models.json ]; then
            proteingym-base list-models models | jq '[.[] | select(.tags | contains(["zero-shot"]))] | map({name: .name, input_filename: .input_filename}) | {models: .}' > benchmark/zero_shot/models.json
          else
            echo "benchmark/zero_shot/models.json already exists, skipping generation"
          fi
          
      - name: Run model validation
        env:
          repo_token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: | 
          # Supervised game: Run DVC repro
          dvc repro benchmark/supervised/dvc.yaml --single-item
  
          # Zero-shot game: Run DVC repro
          dvc repro benchmark/zero_shot/dvc.yaml --single-item

          # Create report with metrics
          echo "# Model Validation Report" >> report.md
          echo "" >> report.md

          cat <<EOF > report.md
          ## Supervised Models
          ✅ Supervised models have all passed validation.
          Picking one supervised model \`pls\`, its metric based on the dataset \`NEIME_2019\` is as below:
          \`\`\`json
          $(cat ./benchmark/supervised/metric/NEIME_2019_pls.json)
          \`\`\`
          ## Zero-shot Models
          ✅ Zero-shot models have all passed validation.
          Picking one zero-shot model \`esm\`, its metric based on the dataset \`ranganathan\` is as below:
          \`\`\`json
          $(cat ./benchmark/zero_shot/metric/ranganathan_esm.json)
          \`\`\`
          EOF
          
          # Send comment to PR
          echo "Send comment to PR"
          cml comment create report.md

      - name: Commit and push DVC lock files
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Pull latest changes from remote
          git pull origin ${{ github.head_ref }} --rebase || true

          # Add and commit files
          git add benchmark/supervised/dvc.lock benchmark/zero_shot/dvc.lock
          git add benchmark/supervised/datasets.json benchmark/zero_shot/datasets.json
          git add benchmark/supervised/models.json benchmark/zero_shot/models.json
          git add benchmark/supervised/metric benchmark/zero_shot/metric --force

          # Commit if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update DVC lock files with the results of metrics [skip ci]"
            git push origin HEAD:${{ github.head_ref }}
          fi