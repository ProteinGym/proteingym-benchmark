name: validate-model

on:    
  workflow_dispatch:
  pull_request:
    branches: main
  

jobs:
  cml:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: iterative/setup-cml@v2

      - uses: astral-sh/setup-uv@v1

      - uses: actions/setup-python@v4
        with:
          python-version-file: ".python-version"

      - name: Run model validation
        env:
          repo_token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: |
          # Configure PAT to git clone the private repo: proteingym-base
          git config --global credential.helper store
          echo "https://${{ secrets.USERNAME }}:${{ secrets.PERSONAL_ACCESS_TOKEN }}@github.com" > ~/.git-credentials
          uv sync
     
          # Run DVC repro
          echo "https://${{ secrets.USERNAME }}:${{ secrets.PERSONAL_ACCESS_TOKEN }}@github.com" > benchmark/supervised/git-auth.txt
          echo "https://${{ secrets.USERNAME }}:${{ secrets.PERSONAL_ACCESS_TOKEN }}@github.com" > benchmark/zero_shot/git-auth.txt
          uv run dvc repro benchmark/supervised/local/dvc.yaml
          uv run dvc repro benchmark/zero_shot/local/dvc.yaml
          
          # Create report with metrics
          # Pick one supervised model
          echo "✅ Supervised models have all passed validation." >> report.md
          echo '```csv' >> report.md
          cat ./benchmark/supervised/local/metric/charge_ladder_pls.csv >> report.md
          echo '```' >> report.md

          # Pick one zero-shot model
          echo "✅ Zero-shot models have all passed validation." >> report.md
          echo '```csv' >> report.md
          cat ./benchmark/zero_shot/local/metric/ranganathan_esm.csv >> report.md
          echo '```' >> report.md
          
          # Send comment to PR
          echo "Send comment to PR"
          cml comment create report.md
