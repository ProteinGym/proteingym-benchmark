schema: '2.0'
stages:
  deploy_to_ecr@model0:
    cmd:
    - aws ecr describe-repositories --repository-names esm --region us-east-1 >/dev/null
      2>&1 || aws ecr create-repository --repository-name esm --region us-east-1 >/dev/null
    - aws ecr get-login-password --region us-east-1 | docker login --username AWS
      --password-stdin ${AWS_ACCOUNT_ID}.dkr.ecr.us-east-1.amazonaws.com
    - docker buildx build --build-arg GIT_CACHE_BUST=1 --platform linux/amd64,linux/arm64
      --secret id=git_auth,src=git-auth.txt -t ${AWS_ACCOUNT_ID}.dkr.ecr.us-east-1.amazonaws.com/esm:latest
      ../models/esm --push
    - echo "ECR push completed at $(date)" > logs/ecr_push_complete.txt
    - echo "${AWS_ACCOUNT_ID}.dkr.ecr.us-east-1.amazonaws.com/esm:latest" > logs/image_uri.txt
    deps:
    - path: ../models/esm
      hash: md5
      md5: 6abde348b69e61d97805679d3caef6e6.dir
      size: 831071033
      nfiles: 30601
    outs:
    - path: logs/ecr_push_complete.txt
      hash: md5
      md5: ad5856ae71ff1cc007d73a268555fd75
      size: 52
    - path: logs/image_uri.txt
      hash: md5
      md5: 84aa521e204015326fa020971afb4fe5
      size: 56
  upload_to_s3:
    cmd:
    - aws s3 cp ../datasets/ s3://mango-pe/pg2-benchmark-training-data/datasets --recursive
      --exclude "*" --include "*.zip"
    - aws s3 cp ../models/ s3://mango-pe/pg2-benchmark-training-data/models --recursive
      --exclude "*" --include "*.toml"
    - echo "Upload completed at $(date)" > logs/s3_upload_complete.txt
    deps:
    - path: ../datasets/
      hash: md5
      md5: 59b322ff2c849cb556c91e169a581bc8.dir
      size: 99844
      nfiles: 6
    - path: ../models/
      hash: md5
      md5: 789a510506845f5474cb955bd0cefffb.dir
      size: 1376991179
      nfiles: 48330
    outs:
    - path: logs/s3_upload_complete.txt
      hash: md5
      md5: 3f05d69f85de388e502f53da2785afdd
      size: 50
  create_training_job@dataset0-model0:
    cmd: "uv run pg2-benchmark aws create-training-job --model-name esm --region-name
      us-east-1 --sagemaker-role-name rnd-dev-sagemakerexecutionrole  --ecr-repository-uri
      ${AWS_ACCOUNT_ID}.dkr.ecr.us-east-1.amazonaws.com/esm --s3-training-data-prefix
      mango-pe/pg2-benchmark-training-data --s3-output-prefix mango-pe/pg2-benchmark-output
      --instance-type ml.m5.xlarge --volume-size 5 --dataset-prefix ranganathan --model-prefix
      esm > logs/create_job_ranganathan_esm.txt\n"
    deps:
    - path: ../src/pg2_benchmark/cli/aws.py
      hash: md5
      md5: c9ab30aefe5bc387546805c51ec2736f
      size: 5157
    - path: logs/ecr_push_complete.txt
      hash: md5
      md5: ad5856ae71ff1cc007d73a268555fd75
      size: 52
    - path: logs/image_uri.txt
      hash: md5
      md5: 84aa521e204015326fa020971afb4fe5
      size: 56
    - path: logs/s3_upload_complete.txt
      hash: md5
      md5: 3f05d69f85de388e502f53da2785afdd
      size: 50
    outs:
    - path: logs/create_job_ranganathan_esm.txt
      hash: md5
      md5: 8bb8079c936f6e4b08bc8970f1eaf82c
      size: 20
  monitor_training_job@dataset0-model0:
    cmd: "uv run pg2-benchmark aws monitor-training-job --region-name us-east-1 --job-name
      $(cat logs/create_job_ranganathan_esm.txt) > logs/monitor_job_ranganathan_esm.txt\n"
    deps:
    - path: ../src/pg2_benchmark/cli/aws.py
      hash: md5
      md5: c9ab30aefe5bc387546805c51ec2736f
      size: 5157
    - path: logs/create_job_ranganathan_esm.txt
      hash: md5
      md5: 8bb8079c936f6e4b08bc8970f1eaf82c
      size: 20
    outs:
    - path: logs/monitor_job_ranganathan_esm.txt
      hash: md5
      md5: fd47074141fa47863c0baff6bbda13c4
      size: 365
  calculate_metric@dataset0-model0:
    cmd:
    - aws s3 cp s3://mango-pe/pg2-benchmark-output/$(cat logs/create_job_ranganathan_esm.txt)/output/model.tar.gz
      output/aws/
    - tar -xzf output/aws/model.tar.gz -C output/aws/
    - rm output/aws/model.tar.gz
    - uv run pg2-benchmark metric calc --output-path output/aws/ranganathan_esm.csv
      --metric-path metric/aws/ranganathan_esm.csv
    deps:
    - path: logs/monitor_job_ranganathan_esm.txt
      hash: md5
      md5: fd47074141fa47863c0baff6bbda13c4
      size: 365
    outs:
    - path: metric/aws/ranganathan_esm.csv
      hash: md5
      md5: 593748e41a369649106260764a45f8ae
      size: 1515
