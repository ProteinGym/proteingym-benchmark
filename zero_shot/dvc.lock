schema: '2.0'
stages:
  zero_shot_predict@dataset0-model0:
    cmd: uv run pg2-benchmark model predict --dataset-manifest data/ranganathan/ranganathan.toml
      --model-manifest model/esm.toml --model-dockerfile-folder ../models/esm --model-name
      esm
    deps:
    - path: ../models/esm
      hash: md5
      md5: 72affc31a799609278cf98508f95be9f.dir
      size: 831070514
      nfiles: 30600
    - path: ../src/pg2_benchmark/cli/model.py
      hash: md5
      md5: 7b69bd48d88f96c7e759334208c24226
      size: 1687
    - path: data/ranganathan/ranganathan.toml
      hash: md5
      md5: ec8bc8dfa7b6415a9b70a417994e306d
      size: 986
    - path: model/esm.toml
      hash: md5
      md5: 64b3f9c9ca8ca6553bc695a1fba4d974
      size: 111
    outs:
    - path: output/ranganathan_esm.csv
      hash: md5
      md5: 39b2dea9bd44e696936e6b3e4f1a4a4c
      size: 195883
  zero_shot_metric@dataset0-model0:
    cmd: uv run pg2-benchmark metric calc --output-path output/ranganathan_esm.csv
      --metric-path metric/ranganathan_esm.csv
    deps:
    - path: ../src/pg2_benchmark/cli/metric.py
      hash: md5
      md5: 2f2a5d08badb89c5d507fa9e2e5bbe2d
      size: 774
    - path: output/ranganathan_esm.csv
      hash: md5
      md5: 39b2dea9bd44e696936e6b3e4f1a4a4c
      size: 195883
    outs:
    - path: metric/ranganathan_esm.csv
      hash: md5
      md5: f38bb057ff25591c67c5985a58af8d1f
      size: 1588
  predict@dataset0-model0:
    cmd: uv run pg2-benchmark model predict --dataset-manifest data/ranganathan/ranganathan.toml
      --model-manifest model/esm.toml --model-dockerfile-folder ../models/esm --model-name
      esm
    deps:
    - path: ../models/esm
      hash: md5
      md5: 72affc31a799609278cf98508f95be9f.dir
      size: 831070514
      nfiles: 30600
    - path: ../src/pg2_benchmark/cli/model.py
      hash: md5
      md5: 7b69bd48d88f96c7e759334208c24226
      size: 1687
    - path: data/ranganathan/ranganathan.toml
      hash: md5
      md5: ec8bc8dfa7b6415a9b70a417994e306d
      size: 986
    - path: model/esm.toml
      hash: md5
      md5: 64b3f9c9ca8ca6553bc695a1fba4d974
      size: 111
    outs:
    - path: output/ranganathan_esm.csv
      hash: md5
      md5: 39b2dea9bd44e696936e6b3e4f1a4a4c
      size: 195883
  calc_metric@dataset0-model0:
    cmd: uv run pg2-benchmark metric calc --output-path output/ranganathan_esm.csv
      --metric-path metric/ranganathan_esm.csv
    deps:
    - path: ../src/pg2_benchmark/cli/metric.py
      hash: md5
      md5: 2f2a5d08badb89c5d507fa9e2e5bbe2d
      size: 774
    - path: output/ranganathan_esm.csv
      hash: md5
      md5: 39b2dea9bd44e696936e6b3e4f1a4a4c
      size: 195883
    outs:
    - path: metric/ranganathan_esm.csv
      hash: md5
      md5: f38bb057ff25591c67c5985a58af8d1f
      size: 1588
  upload_to_s3:
    cmd:
    - aws s3 cp data/ s3://mango-pe/pg2-benchmark-training-data/data/ --recursive
      --exclude ".*" --exclude "*/.*"
    - aws s3 cp model/ s3://mango-pe/pg2-benchmark-training-data/model/ --recursive
      --exclude ".*" --exclude "*/.*"
    - echo "Upload completed at $(date)" > logs/s3_upload_complete.txt
    deps:
    - path: data/
      hash: md5
      md5: 93c5f9212e2b2e6e9cfb24b8659ee95d.dir
      size: 1735644
      nfiles: 2
    - path: model/
      hash: md5
      md5: 258c7037ec4e610e0c0c80a758d13aa1.dir
      size: 111
      nfiles: 1
    outs:
    - path: logs/s3_upload_complete.txt
      hash: md5
      md5: 4edb85c09c76bcf5b4521002cb492776
      size: 50
  deploy_to_ecr@model0:
    cmd:
    - aws ecr describe-repositories --repository-names esm --region us-east-1 >/dev/null
      2>&1 || aws ecr create-repository --repository-name esm --region us-east-1 >/dev/null
    - aws ecr get-login-password --region us-east-1 | docker login --username AWS
      --password-stdin 938398057556.dkr.ecr.us-east-1.amazonaws.com
    - docker buildx build --build-arg GIT_CACHE_BUST=1 --platform linux/amd64,linux/arm64
      --secret id=git_auth,src=git-auth.txt -t 938398057556.dkr.ecr.us-east-1.amazonaws.com/esm:latest
      ../models/esm --push
    - echo "ECR push completed at $(date)" > logs/ecr_push_complete.txt
    - echo "938398057556.dkr.ecr.us-east-1.amazonaws.com/esm:latest" > logs/image_uri.txt
    deps:
    - path: ../models/esm
      hash: md5
      md5: 5f8c2050128558c86e2615727f5c7615.dir
      size: 831072206
      nfiles: 30600
    outs:
    - path: logs/ecr_push_complete.txt
      hash: md5
      md5: 0b887b0e94ad4cd3bb43210837ac0476
      size: 52
    - path: logs/image_uri.txt
      hash: md5
      md5: 84aa521e204015326fa020971afb4fe5
      size: 56
  create_role:
    cmd:
    - aws iam get-role --role-name pg2-benchmark-sagemaker-role >/dev/null 2>&1 ||
      aws iam create-role --role-name pg2-benchmark-sagemaker-role --assume-role-policy-document
      file://trust-policy.json >/dev/null
    - aws iam attach-role-policy --role-name pg2-benchmark-sagemaker-role --policy-arn
      arn:aws:iam::aws:policy/AmazonSageMakerFullAccess
    - aws iam attach-role-policy --role-name pg2-benchmark-sagemaker-role --policy-arn
      arn:aws:iam::aws:policy/AmazonS3FullAccess
    - echo "SageMaker role created at $(date)" > logs/role_create_complete.txt
    deps:
    - path: logs/ecr_push_complete.txt
      hash: md5
      md5: a81ded117627fd6c20e4d532ea7f999d
      size: 52
    - path: logs/image_uri.txt
      hash: md5
      md5: c5a510e7369665b7532a8afbce6ea0bb
      size: 57
    - path: logs/s3_upload_complete.txt
      hash: md5
      md5: a1a378be5887fd4066d4e33b2cf7514d
      size: 50
    outs:
    - path: logs/role_create_complete.txt
      hash: md5
      md5: 469e5283ef35cd26b05d4cda9578244c
      size: 56
  create_training_job@dataset0-model0:
    cmd: "uv run pg2-benchmark aws create-training-job --model-name esm --region-name
      us-east-1 --sagemaker-role-name rnd-dev-sagemakerexecutionrole  --ecr-repository-uri
      938398057556.dkr.ecr.us-east-1.amazonaws.com/esm --s3-training-data-prefix mango-pe/pg2-benchmark-training-data
      --s3-output-prefix mango-pe/pg2-benchmark-output --instance-type ml.m5.xlarge
      --volume-size 5 --dataset-toml-file data/ranganathan/ranganathan.toml --model-toml-file
      model/esm.toml > logs/create_job_ranganathan_esm.txt\n"
    deps:
    - path: ../src/pg2_benchmark/cli/aws.py
      hash: md5
      md5: 73c644bad8c7bdf688d6e6c521ff9c8c
      size: 4967
    - path: logs/ecr_push_complete.txt
      hash: md5
      md5: 0b887b0e94ad4cd3bb43210837ac0476
      size: 52
    - path: logs/image_uri.txt
      hash: md5
      md5: 84aa521e204015326fa020971afb4fe5
      size: 56
    - path: logs/s3_upload_complete.txt
      hash: md5
      md5: 4edb85c09c76bcf5b4521002cb492776
      size: 50
    outs:
    - path: logs/create_job_ranganathan_esm.txt
      hash: md5
      md5: 1a37e0281c3b800317263fecbb9e886e
      size: 20
  monitor_training_job@dataset0-model0:
    cmd: "uv run pg2-benchmark aws monitor-training-job --region-name us-east-1 --job-name
      $(cat logs/create_job_ranganathan_esm.txt) > logs/monitor_job_ranganathan_esm.txt\n"
    deps:
    - path: ../src/pg2_benchmark/cli/aws.py
      hash: md5
      md5: 73c644bad8c7bdf688d6e6c521ff9c8c
      size: 4967
    - path: logs/create_job_ranganathan_esm.txt
      hash: md5
      md5: 1a37e0281c3b800317263fecbb9e886e
      size: 20
    outs:
    - path: logs/monitor_job_ranganathan_esm.txt
      hash: md5
      md5: 03382b78c1dbd232429b8a6919abc6b8
      size: 365
  calculate_metric@dataset0-model0:
    cmd:
    - aws s3 cp s3://mango-pe/pg2-benchmark-output/$(cat logs/create_job_ranganathan_esm.txt)/output/model.tar.gz
      output/aws/
    - tar -xzf output/aws/model.tar.gz -C output/aws/
    - rm output/aws/model.tar.gz
    - uv run pg2-benchmark metric calc --output-path output/aws/ranganathan_esm.csv
      --metric-path metric/aws/ranganathan_esm.csv
    deps:
    - path: logs/monitor_job_ranganathan_esm.txt
      hash: md5
      md5: 03382b78c1dbd232429b8a6919abc6b8
      size: 365
    outs:
    - path: metric/aws/ranganathan_esm.csv
      hash: md5
      md5: 593748e41a369649106260764a45f8ae
      size: 1515
