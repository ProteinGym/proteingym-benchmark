schema: '2.0'
stages:
  create_training_job@dataset0-model0:
    cmd:
    - docker build --build-arg GIT_CACHE_BUST=1 --secret id=git_auth,src=../git-auth.txt
      -f ../../../models/esm/Dockerfile -t esm:latest ../../..
    - docker run --rm -v $(realpath ../../../datasets):/datasets -v $(realpath ../../../models):/models
      -v $(realpath output):/opt/ml/model esm:latest train --dataset-file /datasets/ranganathan/dataset.zip
      --model-card-file /models/esm/README.md
    - docker image prune -a -f
    deps:
    - path: ../../../datasets/ranganathan/dataset.zip
      hash: md5
      md5: b7c8410bc7d34c92e8d11d8b0064fbc7
      size: 39040
    - path: ../../../models/esm/Dockerfile
      hash: md5
      md5: 7f13567daf55f157ab05f23602a1f53e
      size: 1138
    - path: ../../../models/esm/README.md
      hash: md5
      md5: 10e1bc81ab111c1023db5b3df2f77e0f
      size: 1741
    - path: logs/setup.txt
      hash: md5
      md5: c861b0c201d5e28492f5dff8fab634f5
      size: 26
    outs:
    - path: output/ranganathan_esm.csv
      hash: md5
      md5: 39b2dea9bd44e696936e6b3e4f1a4a4c
      size: 195883
  calculate_metric@dataset0-model0:
    cmd: uv run pg2-benchmark metric calc --output-path output/ranganathan_esm.csv
      --metric-path metric/ranganathan_esm.csv
    deps:
    - path: output/ranganathan_esm.csv
      hash: md5
      md5: 39b2dea9bd44e696936e6b3e4f1a4a4c
      size: 195883
    outs:
    - path: metric/ranganathan_esm.csv
      hash: md5
      md5: f38bb057ff25591c67c5985a58af8d1f
      size: 1588
  setup:
    cmd:
    - mkdir -p logs output metric
    - echo "Created local directories" > logs/setup.txt
    outs:
    - path: logs/setup.txt
      hash: md5
      md5: c861b0c201d5e28492f5dff8fab634f5
      size: 26
