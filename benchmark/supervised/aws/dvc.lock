schema: '2.0'
stages:
  upload_to_s3:
    cmd:
    - aws s3 cp ../../../datasets/ s3://mango-pe/pg2-benchmark-training-data/datasets
      --recursive --exclude "*" --include "*.zip"
    - aws s3 cp ../../../models/ s3://mango-pe/pg2-benchmark-training-data/models
      --recursive --exclude "*" --include "README.md"
    - echo "Upload completed at $(date)" > logs/s3_upload_complete.txt
    deps:
    - path: ../../../datasets/
      hash: md5
      md5: 2d7736631bb389bc4c1775cc7979f0a0.dir
      size: 105992
      nfiles: 7
    - path: ../../../models/
      hash: md5
      md5: 8a2a310671abbb469d6d45d56c1ec859.dir
      size: 1381200239
      nfiles: 48391
    - path: logs/setup.txt
      hash: md5
      md5: c861b0c201d5e28492f5dff8fab634f5
      size: 26
    outs:
    - path: logs/s3_upload_complete.txt
      hash: md5
      md5: 2de978e81f106363692c3c775ae44ecb
      size: 50
  deploy_to_ecr@model0:
    cmd:
    - aws ecr describe-repositories --repository-names pls --region us-east-1 >/dev/null
      2>&1 || aws ecr create-repository --repository-name pls --region us-east-1 >/dev/null
    - aws ecr get-login-password --region us-east-1 | docker login --username AWS
      --password-stdin ${AWS_ACCOUNT_ID}.dkr.ecr.us-east-1.amazonaws.com
    - docker buildx build --build-arg GIT_CACHE_BUST=2 --platform linux/amd64,linux/arm64
      --secret id=git_auth,src=../git-auth.txt -f ../../../models/pls/Dockerfile -t
      ${AWS_ACCOUNT_ID}.dkr.ecr.us-east-1.amazonaws.com/pls:latest ../../.. --push
    - echo "ECR push completed at $(date)" > logs/ecr_push_complete.txt
    - echo "${AWS_ACCOUNT_ID}.dkr.ecr.us-east-1.amazonaws.com/pls:latest" > logs/image_uri.txt
    deps:
    - path: ../../../models/pls/Dockerfile
      hash: md5
      md5: 901a42e51cf4a14665099985ee9c30de
      size: 1138
    - path: logs/setup.txt
      hash: md5
      md5: c861b0c201d5e28492f5dff8fab634f5
      size: 26
    outs:
    - path: logs/ecr_push_complete.txt
      hash: md5
      md5: 8225867a9f663498ab8e7812c97e0d9a
      size: 52
    - path: logs/image_uri.txt
      hash: md5
      md5: 764fdb00245735eff50661b2da0d51a1
      size: 56
  create_training_job@dataset0-model0:
    cmd: "uv run pg2-benchmark sagemaker create-training-job --model-name pls --region-name
      us-east-1 --sagemaker-role-name rnd-dev-sagemakerexecutionrole --ecr-repository-uri
      ${AWS_ACCOUNT_ID}.dkr.ecr.us-east-1.amazonaws.com/pls --s3-training-data-prefix
      mango-pe/pg2-benchmark-training-data --s3-output-prefix mango-pe/pg2-benchmark-output
      --instance-type ml.m5.xlarge --volume-size 5 --dataset-prefix dummy --model-prefix
      pls > logs/create_job_charge_ladder_pls.txt\n"
    deps:
    - path: ../../../src/pg2_benchmark/cli/sagemaker.py
      hash: md5
      md5: 47ce56161a649f4829dd64c6bde4b4bf
      size: 5178
    - path: logs/ecr_push_complete.txt
      hash: md5
      md5: 8225867a9f663498ab8e7812c97e0d9a
      size: 52
    - path: logs/image_uri.txt
      hash: md5
      md5: 764fdb00245735eff50661b2da0d51a1
      size: 56
    - path: logs/s3_upload_complete.txt
      hash: md5
      md5: 2de978e81f106363692c3c775ae44ecb
      size: 50
    outs:
    - path: logs/create_job_charge_ladder_pls.txt
      hash: md5
      md5: 9840699441bb4a04e370720b50541308
      size: 20
  create_training_job@dataset1-model0:
    cmd: "uv run pg2-benchmark sagemaker create-training-job --model-name pls --region-name
      us-east-1 --sagemaker-role-name rnd-dev-sagemakerexecutionrole --ecr-repository-uri
      ${AWS_ACCOUNT_ID}.dkr.ecr.us-east-1.amazonaws.com/pls --s3-training-data-prefix
      mango-pe/pg2-benchmark-training-data --s3-output-prefix mango-pe/pg2-benchmark-output
      --instance-type ml.m5.xlarge --volume-size 5 --dataset-prefix neime --model-prefix
      pls > logs/create_job_neime_pls.txt\n"
    deps:
    - path: ../../../src/pg2_benchmark/cli/sagemaker.py
      hash: md5
      md5: 47ce56161a649f4829dd64c6bde4b4bf
      size: 5178
    - path: logs/ecr_push_complete.txt
      hash: md5
      md5: 8225867a9f663498ab8e7812c97e0d9a
      size: 52
    - path: logs/image_uri.txt
      hash: md5
      md5: 764fdb00245735eff50661b2da0d51a1
      size: 56
    - path: logs/s3_upload_complete.txt
      hash: md5
      md5: 2de978e81f106363692c3c775ae44ecb
      size: 50
    outs:
    - path: logs/create_job_neime_pls.txt
      hash: md5
      md5: b2760cf024c3f96ce24798aa7566f8c0
      size: 20
  monitor_training_job@dataset0-model0:
    cmd: "uv run pg2-benchmark sagemaker monitor-training-job --region-name us-east-1
      --job-name $(cat logs/create_job_charge_ladder_pls.txt) > logs/monitor_job_charge_ladder_pls.txt\n"
    deps:
    - path: ../../../src/pg2_benchmark/cli/sagemaker.py
      hash: md5
      md5: 47ce56161a649f4829dd64c6bde4b4bf
      size: 5178
    - path: logs/create_job_charge_ladder_pls.txt
      hash: md5
      md5: 9840699441bb4a04e370720b50541308
      size: 20
    outs:
    - path: logs/monitor_job_charge_ladder_pls.txt
      hash: md5
      md5: b83ea2ee7bc48007cd5f240683cdc043
      size: 245
  monitor_training_job@dataset1-model0:
    cmd: "uv run pg2-benchmark sagemaker monitor-training-job --region-name us-east-1
      --job-name $(cat logs/create_job_neime_pls.txt) > logs/monitor_job_neime_pls.txt\n"
    deps:
    - path: ../../../src/pg2_benchmark/cli/sagemaker.py
      hash: md5
      md5: 47ce56161a649f4829dd64c6bde4b4bf
      size: 5178
    - path: logs/create_job_neime_pls.txt
      hash: md5
      md5: b2760cf024c3f96ce24798aa7566f8c0
      size: 20
    outs:
    - path: logs/monitor_job_neime_pls.txt
      hash: md5
      md5: 930f15c1dc41b2d72f0d24c430dd4609
      size: 216
  calculate_metric@dataset0-model0:
    cmd:
    - aws s3 cp s3://mango-pe/pg2-benchmark-output/$(cat logs/create_job_charge_ladder_pls.txt)/output/model.tar.gz
      output/
    - tar -xzf output/model.tar.gz -C output/
    - rm output/model.tar.gz
    - uv run pg2-benchmark metric calc --output-path output/charge_ladder_pls.csv
      --metric-path metric/charge_ladder_pls.csv
    deps:
    - path: logs/monitor_job_charge_ladder_pls.txt
      hash: md5
      md5: b83ea2ee7bc48007cd5f240683cdc043
      size: 245
    outs:
    - path: metric/charge_ladder_pls.csv
      hash: md5
      md5: a94b29b80493faa875ea39623058344b
      size: 1457
  calculate_metric@dataset1-model0:
    cmd:
    - aws s3 cp s3://mango-pe/pg2-benchmark-output/$(cat logs/create_job_neime_pls.txt)/output/model.tar.gz
      output/
    - tar -xzf output/model.tar.gz -C output/
    - rm output/model.tar.gz
    - uv run pg2-benchmark metric calc --output-path output/neime_pls.csv --metric-path
      metric/neime_pls.csv
    deps:
    - path: logs/monitor_job_neime_pls.txt
      hash: md5
      md5: 930f15c1dc41b2d72f0d24c430dd4609
      size: 216
    outs:
    - path: metric/neime_pls.csv
      hash: md5
      md5: 43a6a51e0ff20d2a322412eac6e524bb
      size: 1616
  setup:
    cmd:
    - mkdir -p logs output metric
    - echo "Created local directories" > logs/setup.txt
    outs:
    - path: logs/setup.txt
      hash: md5
      md5: c861b0c201d5e28492f5dff8fab634f5
      size: 26
